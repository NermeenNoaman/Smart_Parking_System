<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Management System - SmartPark</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --gray: #9ca3af;
        }
        body {
            background-color: #f8fafc;
            color: #334155;
            min-height: 100vh;
            direction: ltr;
        }
        /* Authentication Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0fdfa 100%);
            padding: 20px;
        }
        .auth-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
        }
        .auth-header {
            background: var(--primary);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .auth-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .auth-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .auth-form {
            padding: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        .auth-footer {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #eee;
            font-size: 14px;
        }
        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            background: #f9fafb;
            font-weight: 600;
        }
        .auth-tab.active {
            background: white;
            border-bottom: 2px solid var(--primary);
        }
        /* Main Application Styles */
        .main-app {
            display: none;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .app-header {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 20px;
            color: var(--primary);
        }
        .nav-menu {
            display: flex;
            gap: 5px;
        }
        .nav-item {
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        .nav-item:hover,
        .nav-item.active {
            background: #f1f5f9;
            color: var(--primary);
        }
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .app-content {
            padding: 30px 0;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e0f2fe;
            color: var(--primary);
        }
        .card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .card-text {
            font-size: 14px;
            color: var(--gray);
        }
        .parking-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .parking-slot {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s;
            cursor: pointer;
        }
        .parking-slot:hover {
            transform: translateY(-5px);
        }
        .slot-number {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .slot-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
        }
        .status-available {
            background: #dcfce7;
            color: #16a34a;
        }
        .status-occupied {
            background: #fee2e2;
            color: #dc2626;
        }
        .status-reserved {
            background: #fef3c7;
            color: #d97706;
        }
        .slot-timer {
            font-size: 14px;
            color: var(--gray);
            margin-top: 5px;
        }
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e0f2fe;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }












        /* Chat Bot Styles */
         .chatbot-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    z-index: 1000;
    transition: transform 0.3s;
             }

         .chatbot-btn:hover {
              transform: scale(1.1);
            }

         .chatbot-container {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 350px;
    height: 500px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    z-index: 1000;
          }

         .chatbot-header {
    background: var(--primary);
    color: white;
    padding: 15px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
          }

         .chatbot-header h3 {
    margin: 0;
    font-size: 16px;
           }

        .chat-close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
           }

         .chatbot-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
           }

         .chat-message {
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    word-wrap: break-word;
            }

        .user-message {
    background: var(--primary);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 5px;
            }

        .bot-message {
    background: #f1f5f9;
    color: var(--dark);
    align-self: flex-start;
    border-bottom-left-radius: 5px;
            }

        .chatbot-input {
    display: flex;
    padding: 15px;
    border-top: 1px solid #eee;
    gap: 10px;
            }

         .chatbot-input input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 25px;
    outline: none;
            }

        .chatbot-input button {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
            }



















        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .nav-menu {
                display: none;
            }
            .header-content {
                padding: 0 15px;
            }
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .slot-details-container {
            display: none;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        .slot-details-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .slot-details-card h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: var(--dark);
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .detail-item:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: 500;
            color: var(--gray);
        }
        .detail-value {
            font-weight: 600;
            color: var(--dark);
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table thead th {
            background-color: var(--dark);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
        }
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        .data-table tbody tr:hover {
            background-color: #f8fafc;
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        .section-title {
            margin-bottom: 20px;
            font-size: 24px;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .refresh-btn:hover {
            background: var(--primary-dark);
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 15px;
            background: #f1f5f9;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1>Parking Management System</h1>
                <p>Effortlessly manage your parking facilities</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Login</div>
                <div class="auth-tab" id="registerTab">Register</div>
            </div>
            <div id="loginScreen" class="auth-form">
                <div id="loginMessage"></div>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" id="loginBtn">Login</button>
            </div>
            <div id="registerScreen" class="auth-form" style="display: none;">
                <div id="registerMessage"></div>
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" placeholder="Confirm your password">
                </div>
                <div class="form-group">
                    <label for="registerLicensePlate">License Plate</label>
                    <input type="text" id="registerLicensePlate" placeholder="e.g., ABC-1234">
                </div>
                <div class="form-group">
                    <label for="registerCarModel">Car Model</label>
                    <input type="text" id="registerCarModel" placeholder="e.g., Toyota Camry">
                </div>
                <div class="form-group">
                    <label for="registerVehicleSize">Vehicle Size</label>
                    <select id="registerVehicleSize">
                        <option value="small">Small</option>
                        <option value="medium">Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="registerPhoneNumber">Phone Number</label>
                    <input type="tel" id="registerPhoneNumber" placeholder="e.g., +201234567890">
                </div>
                <div class="form-group">
                    <label for="registerPreferredSlot">Preferred Parking Slot</label>
                    <input type="text" id="registerPreferredSlot" placeholder="e.g., Slot 1">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="registerNotifyOnFree">
                        Notify me when a slot is free
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="registerAutoGateEnabled">
                        Enable automatic gate access
                    </label>
                </div>
                <button class="btn btn-secondary" id="registerBtn">Register</button>
            </div>
            <div class="auth-footer">
                <p>By continuing, you agree to the <a href="#">Terms of Service</a></p>
            </div>
        </div>
    </div>
    <div id="mainApp" class="main-app">
        <header class="app-header">
            <div class="container header-content">
                <div class="logo">
                    <i class="fas fa-parking"></i>
                    <span>SmartPark</span>
                </div>
                <nav class="nav-menu">
                    <div class="nav-item active" onclick="showSection('dashboardSection')">Dashboard</div>
                    <div class="nav-item" onclick="showSection('systemStatusSection'); fetchSystemStatus();">System</div>
                    <div class="nav-item" onclick="showSection('dataViewerSection'); fetchAllData();">Data Viewer</div>
                </nav>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">JD</div>
                    <div id="userName">John Doe</div>
                    <button id="logoutBtn" style="background: none; border: none; cursor: pointer; margin-right: 10px;">
                        <i class="fas fa-sign-out-alt" style="color: var(--danger);"></i>
                    </button>
                </div>
            </div>
        </header>










<!-- Chat Bot Button -->
<div class="chatbot-btn" onclick="toggleChat()">
    <i class="fas fa-comments"></i>
</div>

<!-- Chat Bot Container -->
<div class="chatbot-container" id="chatbotContainer">
    <div class="chatbot-header">
        <h3>SmartPark Assistant</h3>
        <button class="chat-close-btn" onclick="toggleChat()">Ã—</button>
    </div>
    <div class="chatbot-messages" id="chatbotMessages">
        <div class="chat-message bot-message">
            Welcome to SmartPark! How can I help you today? ðŸš—
        </div>
    </div>
    <div class="chatbot-input">
        <input type="text" id="chatInput" placeholder="Ask about parking status...">
        <button onclick="sendChatMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>


















        <main class="app-content">
            <div class="container">
                <div id="dashboardSection">
                    <h2 style="margin-bottom: 20px;">Parking Dashboard</h2>
                    <div class="dashboard">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Total Slots</div>
                                <div class="card-icon">
                                    <i class="fas fa-parking"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalSlotsValue">--</div>
                            <div class="card-text">Total capacity across floors</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Available Now</div>
                                <div class="card-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="card-value" id="availableSlotsValue">--</div>
                            <div class="card-text">Slots currently available</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Occupied</div>
                                <div class="card-icon">
                                    <i class="fas fa-car"></i>
                                </div>
                            </div>
                            <div class="card-value" id="occupiedSlotsValue">--</div>
                            <div class="card-text" id="occupiedRateText">--</div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Rain Status</div>
                                <div class="card-icon">
                                    <i class="fas fa-cloud-rain"></i>
                                </div>
                            </div>
                            <div class="card-value" id="rainStatusValue">--</div>
                            <div class="card-text">Current weather condition</div>
                        </div>
                    </div>
                    <div id="parkingGrid"></div>
                    <div id="slotDetailsContainer" class="slot-details-container">
                        <div class="slot-details-card">
                            <h3>Slot Details</h3>
                            <div class="detail-item">
                                <span class="detail-label">Slot ID:</span>
                                <span class="detail-value" id="detailSlotId">--</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Is Occupied:</span>
                                <span class="detail-value" id="detailIsOccupied">--</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">License Plate:</span>
                                <span class="detail-value" id="detailLicensePlate">--</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">LED Status:</span>
                                <span class="detail-value" id="detailLedStatus">--</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Sensor Readings:</span>
                                <span class="detail-value" id="detailSensorReadings">--</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Last Updated:</span>
                                <span class="detail-value" id="detailLastUpdated">--</span>
                            </div>
                        </div>
                        <div class="slot-details-card">
                            <h3>Manual Control</h3>
                            <div class="detail-item">
                                <span class="detail-label">Change Occupancy:</span>
                                <div class="control-buttons">
                                    <button class="btn btn-primary" onclick="updateSlotStatus(selectedSlotId, true)">Set Occupied</button>
                                    <button class="btn btn-secondary" onclick="updateSlotStatus(selectedSlotId, false)">Set Available</button>
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Update LED:</span>
                                <div class="control-buttons">
                                    <button class="btn btn-primary" onclick="updateLedStatus(selectedSlotId, 'green')">Green</button>
                                    <button class="btn btn-danger" onclick="updateLedStatus(selectedSlotId, 'red')">Red</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="systemStatusSection" style="display: none;">
                    <h2 style="margin-bottom: 20px;">Overall System Status</h2>
                    <div class="dashboard">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Environment Status</div>
                                <div class="card-icon"><i class="fas fa-cloud"></i></div>
                            </div>
                            <div class="card-body">
                                <div class="detail-item">
                                    <span class="detail-label">Light Level:</span>
                                    <span class="detail-value" id="envLightLevel">--</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Night Mode:</span>
                                    <span class="detail-value" id="envNightMode">--</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Corner Lights:</span>
                                    <span class="detail-value" id="envCornerLights">--</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Rain Value:</span>
                                    <span class="detail-value" id="envRainValue">--</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Rain Detected:</span>
                                    <span class="detail-value" id="envRainDetected">--</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Rain Threshold:</span>
                                    <span class="detail-value" id="envRainThreshold">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dataViewerSection" style="display: none;">
                    <div class="section-title">
                        <h2>Data Viewer</h2>
                        <button class="refresh-btn" onclick="fetchAllData()">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                    </div>
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="showDataTable('environmentTable')">Environment</button>
                        <button class="tab-btn" onclick="showDataTable('parkingSlotsTable')">Parking Slots</button>
                        <button class="tab-btn" onclick="showDataTable('systemOverviewTable')">System Overview</button>
                        <button class="tab-btn" onclick="showDataTable('accessLogsTable'); fetchAccessLogs();">Access Logs</button>
                    </div>
                    <div id="environmentTable" class="table-container">
                        <h3>Environment Data</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Light Level</th>
                                    <th>Night Mode</th>
                                    <th>Corner Lights</th>
                                    <th>Rain Sensor Value</th>
                                    <th>Rain Detected</th>
                                    <th>Rain Threshold</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody id="environmentBody"></tbody>
                        </table>
                    </div>
                    <div id="parkingSlotsTable" class="table-container" style="display: none;">
                        <h3>Parking Slots</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Slot ID</th>
                                    <th>Is Occupied</th>
                                    <th>Sensor Raw</th>
                                    <th>Sensor Filtered</th>
                                    <th>Last Changed</th>
                                    <th>Stable Readings</th>
                                    <th>LED Status</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody id="parkingSlotsBody"></tbody>
                        </table>
                    </div>
                    <div id="systemOverviewTable" class="table-container" style="display: none;">
                        <h3>System Overview</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Available Slots</th>
                                    <th>Gate Open</th>
                                    <th>Ceiling Closed</th>
                                    <th>Night Mode</th>
                                    <th>Rain Detected</th>
                                    <th>Buzzer Active</th>
                                    <th>Gate Sensor Before</th>
                                    <th>Gate Sensor After</th>
                                    <th>Rain Sensor Value</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody id="systemOverviewBody"></tbody>
                        </table>
                    </div>
                    <div id="accessLogsTable" class="table-container" style="display: none;">
                        <h3>Access Logs</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User ID</th>
                                    <th>Action</th>
                                    <th>IP Address</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="accessLogsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
    <script>
        // Supabase & MQTT Initialization
        const SUPABASE_URL = 'https://fuhjbiswukesrolmbvop.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1aGpiaXN3dWtlc3JvbG1idm9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NjY3MDMsImV4cCI6MjA3MTQ0MjcwM30.hdy1D5W4crVLqKvvmNgyfl7IK00azCnvshitjbLCg9g';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const MQTT_BROKER_URL = 'wss://858a3089681b477597400a3b5c9ba46b.s1.eu.hivemq.cloud:8883';
        const MQTT_OPTIONS = {
            username: 'IOT2025',
            password: 'IOTtraining2025',
            protocol: 'wss',
        };
        let mqttClient;
        let selectedSlotId = null;










            // Chat Bot Functions
function toggleChat() {
    const chatContainer = document.getElementById('chatbotContainer');
    chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
    
    if (chatContainer.style.display === 'flex') {
        document.getElementById('chatInput').focus();
    }
}
async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addChatMessage(message, 'user');
    input.value = '';
    
    try {
        // Show typing indicator
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'chat-message bot-message';
        typingIndicator.innerHTML = '<i>SmartPark is typing...</i>';
        document.getElementById('chatbotMessages').appendChild(typingIndicator);
        document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;

        // 1) Send question to API - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ÙˆÙ„
        await fetch("https://api-drki.onrender.com/submit-question", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({ question: message })
        });

        // 2) Wait a moment and get the answer - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø«Ø§Ù†ÙŠ
        // Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        setTimeout(async () => {
            try {
                const response = await fetch("https://api-drki.onrender.com/get-answer");
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Remove typing indicator
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.removeChild(typingIndicator);
                
                // Add bot response to chat
                addChatMessage(data.answer, 'bot');
                
            } catch (error) {
                // Remove typing indicator
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.removeChild(typingIndicator);
                
                addChatMessage("Sorry, I'm having trouble getting a response. Please try again.", 'bot');
                console.error('Error getting answer:', error);
            }
        }, 2000);
        
    } catch (error) {
        addChatMessage("Sorry, I'm having trouble connecting. Please try again later.", 'bot');
        console.error('Chat error:', error);
    }
}
function addChatMessage(message, type) {
    const messagesContainer = document.getElementById('chatbotMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}-message`;
    messageDiv.textContent = message;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Handle Enter key in chat input
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendChatMessage();
    }
});








        function connectMqtt() {
            mqttClient = mqtt.connect(MQTT_BROKER_URL, MQTT_OPTIONS);
            mqttClient.on('connect', () => {
                console.log('Connected to MQTT broker!');
            });
            mqttClient.on('error', (error) => {
                console.error('MQTT Connection Error:', error);
            });
        }

        function publishMQTTMessage(topic, message) {
            if (mqttClient && mqttClient.connected) {
                mqttClient.publish(topic, message, (err) => {
                    if (err) {
                        console.error(`Failed to publish to topic "${topic}":`, err);
                    } else {
                        console.log(`Successfully published "${message}" to topic "${topic}"`);
                    }
                });
            } else {
                console.error('MQTT client is not connected.');
            }
        }

        // Fetch user's IP address (optional)
        async function getUserIpAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || null;
            } catch (error) {
                console.error('Error fetching IP address:', error.message);
                return null;
            }
        }

        // Log user actions to Supabase
        async function logUserAction(userId, action) {
            try {
                const ipAddress = await getUserIpAddress(); // Fetch IP address
                const { data, error } = await supabase
                    .from('access_logs')
                    .insert([{
                        user_id: userId,
                        action: action,
                        created_at: new Date().toISOString(),
                        ip_address: ipAddress
                    }]);
                if (error) {
                    console.error('Error logging action:', error.message);
                    return;
                }
                console.log(`Logged ${action} for user ${userId} with IP ${ipAddress || 'NULL'}`);
            } catch (err) {
                console.error('Unexpected error logging action:', err.message);
            }
        }

        // Fetch and display access logs
        async function fetchAccessLogs() {
            try {
                const { data, error } = await supabase
                    .from('access_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                if (error) throw error;
                updateAccessLogsTable(data);
            } catch (error) {
                console.error('Error fetching access logs:', error.message);
                document.getElementById('accessLogsBody').innerHTML = '<tr><td colspan="5">Error loading access logs.</td></tr>';
            }
        }

        // Update access logs table
        function updateAccessLogsTable(logs) {
            const accessLogsBody = document.getElementById('accessLogsBody');
            accessLogsBody.innerHTML = '';
            if (logs && logs.length > 0) {
                logs.forEach(log => {
                    const row = `
                        <tr>
                            <td>${log.id}</td>
                            <td>${log.user_id}</td>
                            <td>${log.action}</td>
                            <td>${log.ip_address || '--'}</td>
                            <td>${new Date(log.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                    accessLogsBody.innerHTML += row;
                });
            } else {
                accessLogsBody.innerHTML = '<tr><td colspan="5">No access logs found.</td></tr>';
            }
        }

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const mainApp = document.getElementById('mainApp');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginScreen = document.getElementById('loginScreen');
        const registerScreen = document.getElementById('registerScreen');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const loginMessage = document.getElementById('loginMessage');
        const registerMessage = document.getElementById('registerMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        // Dashboard Elements
        const totalSlotsValue = document.getElementById('totalSlotsValue');
        const availableSlotsValue = document.getElementById('availableSlotsValue');
        const occupiedSlotsValue = document.getElementById('occupiedSlotsValue');
        const occupiedRateText = document.getElementById('occupiedRateText');
        const rainStatusValue = document.getElementById('rainStatusValue');
        // Main sections
        const dashboardSection = document.getElementById('dashboardSection');
        const systemStatusSection = document.getElementById('systemStatusSection');
        const dataViewerSection = document.getElementById('dataViewerSection');
        // Dynamic content containers
        const parkingGrid = document.getElementById('parkingGrid');
        const slotDetailsContainer = document.getElementById('slotDetailsContainer');
        const detailSlotId = document.getElementById('detailSlotId');
        const detailIsOccupied = document.getElementById('detailIsOccupied');
        const detailLedStatus = document.getElementById('detailLedStatus');
        const detailSensorReadings = document.getElementById('detailSensorReadings');
        const detailLicensePlate = document.getElementById('detailLicensePlate');
        const detailLastUpdated = document.getElementById('detailLastUpdated');
        // Environment Status Elements
        const envLightLevel = document.getElementById('envLightLevel');
        const envNightMode = document.getElementById('envNightMode');
        const envCornerLights = document.getElementById('envCornerLights');
        const envRainValue = document.getElementById('envRainValue');
        const envRainDetected = document.getElementById('envRainDetected');
        const envRainThreshold = document.getElementById('envRainThreshold');
        // Data Viewer Elements
        const environmentBody = document.getElementById('environmentBody');
        const parkingSlotsBody = document.getElementById('parkingSlotsBody');
        const systemOverviewBody = document.getElementById('systemOverviewBody');
        const accessLogsBody = document.getElementById('accessLogsBody');

        // --- Tab Switching in Auth Form ---
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginScreen.style.display = 'block';
            registerScreen.style.display = 'none';
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerScreen.style.display = 'block';
            loginScreen.style.display = 'none';
        });

        // --- Navigation Logic ---
        function showSection(sectionId) {
            const sections = [dashboardSection, systemStatusSection, dataViewerSection];
            sections.forEach(sec => sec.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            if (sectionId === 'dashboardSection') {
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            } else if (sectionId === 'systemStatusSection') {
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            } else if (sectionId === 'dataViewerSection') {
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
            }
        }

        // Add event listeners to navigation items
        document.querySelector('.nav-item:nth-child(1)').addEventListener('click', () => {
            fetchDashboardData();
            slotDetailsContainer.style.display = 'none';
        });
        document.querySelector('.nav-item:nth-child(2)').addEventListener('click', () => fetchSystemStatus());
        document.querySelector('.nav-item:nth-child(3)').addEventListener('click', () => fetchAllData());

        // --- Authentication Functions ---
        // Login with Supabase
        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showMessage(loginMessage, 'error', 'Please fill in all fields.');
                return;
            }
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            loadingOverlay.style.display = 'flex';
            try {
                await supabase.auth.signOut(); // Ensure clean state
                await new Promise(resolve => setTimeout(resolve, 500));
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    console.error('Login error:', error);
                    showMessage(loginMessage, 'error', error.message);
                    return;
                }
                if (!data.user) {
                    showMessage(loginMessage, 'error', 'Login failed: No user data received.');
                    return;
                }
                const { data: sessionData } = await supabase.auth.getSession();
                if (!sessionData.session) {
                    showMessage(loginMessage, 'error', 'Login failed: No session created.');
                    return;
                }
                // Log sign-in action
                await logUserAction(data.user.id, 'SIGN_IN');
                console.log('Login successful for user:', data.user.email);
                authContainer.style.display = 'none';
                mainApp.style.display = 'block';
                const userFullName = data.user.user_metadata?.full_name || data.user.email;
                userName.textContent = userFullName;
                userAvatar.textContent = userFullName.charAt(0).toUpperCase();
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                try {
                    await fetchDashboardData();
                    setupRealtimeListeners();
                    connectMqtt();
                } catch (appError) {
                    console.warn('App initialization warning:', appError.message);
                }
            } catch (error) {
                console.error('Unexpected login error:', error);
                showMessage(loginMessage, 'error', 'An unexpected error occurred. Please try again.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
                loadingOverlay.style.display = 'none';
            }
        });

        // Register with Supabase
        registerBtn.addEventListener('click', async () => {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const licensePlate = document.getElementById('registerLicensePlate').value;
            const carModel = document.getElementById('registerCarModel').value;
            const vehicleSize = document.getElementById('registerVehicleSize').value;
            const phoneNumber = document.getElementById('registerPhoneNumber').value;
            const preferredSlot = document.getElementById('registerPreferredSlot').value;
            const notifyOnFree = document.getElementById('registerNotifyOnFree').checked;
            const autoGateEnabled = document.getElementById('registerAutoGateEnabled').checked;
            // Validation
            if (!name || !email || !password || !confirmPassword || !licensePlate || !carModel || !vehicleSize || !phoneNumber) {
                showMessage(registerMessage, 'error', 'Please fill in all required fields.');
                return;
            }
            if (password !== confirmPassword) {
                showMessage(registerMessage, 'error', 'Passwords do not match.');
                return;
            }
            registerBtn.disabled = true;
            registerBtn.textContent = 'Creating Account...';
            loadingOverlay.style.display = 'flex';
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            license_plate: licensePlate,
                            car_model: carModel,
                            vehicle_size: vehicleSize,
                            phone_number: phoneNumber,
                            preferred_slot: preferredSlot || null,
                            notify_on_free: notifyOnFree,
                            auto_gate_enabled: autoGateEnabled
                        }
                    }
                });
                if (error || !data.user) {
                    showMessage(registerMessage, 'error', error?.message || 'Registration failed: No user data returned.');
                    return;
                }
                // Insert into public.users table
                try {
                    const { error: insertError } = await supabase.from('users').upsert({
                        id: data.user.id,
                        full_name: name,
                        license_plate: licensePlate,
                        car_model: carModel,
                        vehicle_size: vehicleSize,
                        phone_number: phoneNumber,
                        preferred_slot: preferredSlot || null,
                        notify_on_free: notifyOnFree,
                        auto_gate_enabled: autoGateEnabled
                    });
                    if (insertError) throw insertError;
                    const message = data.user.confirmed_at ? 'Account created successfully! Please log in.' : 'Account created! Please check your email to verify your account.';
                    showMessage(registerMessage, 'success', message);
                    setTimeout(() => {
                        loginTab.click();
                        document.getElementById('registerName').value = '';
                        document.getElementById('registerEmail').value = '';
                        document.getElementById('registerPassword').value = '';
                        document.getElementById('registerConfirmPassword').value = '';
                        document.getElementById('registerLicensePlate').value = '';
                        document.getElementById('registerCarModel').value = '';
                        document.getElementById('registerVehicleSize').value = 'small';
                        document.getElementById('registerPhoneNumber').value = '';
                        document.getElementById('registerPreferredSlot').value = '';
                        document.getElementById('registerNotifyOnFree').checked = false;
                        document.getElementById('registerAutoGateEnabled').checked = false;
                        registerMessage.textContent = '';
                        registerMessage.className = '';
                    }, 2000);
                } catch (insertError) {
                    // If DB insert fails, delete the Auth user to keep things consistent
                   if (data.user) {
                       await supabase.auth.admin.deleteUser(data.user.id);
                   }
                   showMessage(registerMessage, 'error', 'Failed to save user data: ' + insertError.message + '. Please try again.');
                   console.error("User registration rollback:", insertError.message);
                }
            } catch (error) {
                showMessage(registerMessage, 'error', 'An error occurred during registration: ' + error.message);
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Register';
                loadingOverlay.style.display = 'none';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    await logUserAction(user.id, 'SIGN_OUT');
                }
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Logout failed:', error.message);
                    return;
                }
                localStorage.clear();
                sessionStorage.clear();
                authContainer.style.display = 'flex';
                mainApp.style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            } catch (err) {
                console.error('Unexpected logout error:', err.message);
            }
        });

        // Helper function to display messages
        function showMessage(element, type, message) {
            element.textContent = message;
            element.className = `message ${type}`;
        }

        // --- Data Fetching & Display Logic ---
        async function fetchDashboardData() {
            loadingOverlay.style.display = 'flex';
            showSection('dashboardSection');
            try {
                const { data: parkingSlotsData, error: parkingSlotsError } = await supabase
                    .from('parking_slots')
                    .select('*');
                if (parkingSlotsError) throw parkingSlotsError;
                const latestSlots = {};
                parkingSlotsData.forEach(slot => {
                    if (!latestSlots[slot.slot_id] || new Date(slot.created_at) > new Date(latestSlots[slot.slot_id].created_at)) {
                        latestSlots[slot.slot_id] = slot;
                    }
                });
                const uniqueSlots = Object.values(latestSlots);
                const { data: systemOverviewData, error: systemOverviewError } = await supabase
                    .from('system_overview')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1);
                if (systemOverviewError) throw systemOverviewError;
                updateDashboard(uniqueSlots, systemOverviewData[0]);
                renderParkingSlots(uniqueSlots);
            } catch (error) {
                console.error('Error fetching dashboard data:', error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function updateDashboard(slots, systemOverview) {
            const totalSlots = slots.length;
            const occupiedSlots = slots.filter(slot => slot.is_occupied).length;
            const availableSlots = totalSlots - occupiedSlots;
            const occupiedRate = totalSlots > 0 ? (occupiedSlots / totalSlots * 100).toFixed(0) : 0;
            totalSlotsValue.textContent = totalSlots;
            availableSlotsValue.textContent = availableSlots;
            occupiedSlotsValue.textContent = occupiedSlots;
            occupiedRateText.textContent = `${occupiedRate}% Occupied`;
            if (systemOverview) {
                rainStatusValue.textContent = systemOverview.rain_detected ? 'Raining' : 'Clear';
            }
        }

        function renderParkingSlots(uniqueSlots) {
            parkingGrid.innerHTML = '';
            uniqueSlots.sort((a, b) => a.slot_id - b.slot_id);
            uniqueSlots.forEach(slot => {
                const statusClass = slot.is_occupied ? 'status-occupied' : 'status-available';
                const statusText = slot.is_occupied ? 'Occupied' : 'Available';
                const slotElement = document.createElement('div');
                slotElement.className = 'parking-slot';
                slotElement.innerHTML = `
                    <div class="slot-number">Slot ${slot.slot_id}</div>
                    <span class="slot-status ${statusClass}">${statusText}</span>
                    ${slot.is_occupied && slot.license_plate ? `<div class="slot-timer">Plate: ${slot.license_plate}</div>` : ''}
                `;
                slotElement.addEventListener('click', () => displaySlotDetails(slot));
                parkingGrid.appendChild(slotElement);
            });
        }

        function displaySlotDetails(slot) {
            selectedSlotId = slot.slot_id;
            detailSlotId.textContent = slot.slot_id;
            detailIsOccupied.textContent = slot.is_occupied ? 'Yes' : 'No';
            detailLedStatus.textContent = slot.led_status || '--';
            detailSensorReadings.textContent = `Raw: ${slot.sensor_raw}, Filtered: ${slot.sensor_filtered}`;
            detailLicensePlate.textContent = slot.license_plate || '--';
            detailLastUpdated.textContent = new Date(slot.created_at).toLocaleString() || '--';
            slotDetailsContainer.style.display = 'grid';
        }

        async function updateSlotStatus(slotId, isOccupied) {
            try {
                const { data, error } = await supabase
                    .from('parking_slots')
                    .update({ is_occupied: isOccupied, last_changed: new Date().toISOString() })
                    .eq('slot_id', slotId);
                if (error) throw error;
                console.log(`Updated slot ${slotId} occupancy to ${isOccupied}`);
                fetchDashboardData();
            } catch (error) {
                console.error('Error updating slot status:', error.message);
            }
        }

        async function updateLedStatus(slotId, status) {
            try {
                const { data, error } = await supabase
                    .from('parking_slots')
                    .update({ led_status: status })
                    .eq('slot_id', slotId);
                if (error) throw error;
                console.log(`Updated slot ${slotId} LED status to ${status}`);
                fetchDashboardData();
            } catch (error) {
                console.error('Error updating LED status:', error.message);
            }
        }

        async function fetchSystemStatus() {
            loadingOverlay.style.display = 'flex';
            showSection('systemStatusSection');
            try {
                const { data: statusData, error } = await supabase
                    .from('environment')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1);
                if (error) throw error;
                if (statusData && statusData.length > 0) {
                    updateSystemStatus(statusData[0]);
                }
            } catch (error) {
                console.error('Error fetching system status:', error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function updateSystemStatus(status) {
            envLightLevel.textContent = status.light_level;
            envNightMode.textContent = status.night_mode ? 'On' : 'Off';
            envCornerLights.textContent = status.corner_lights;
            envRainValue.textContent = status.rain_sensor_value;
            envRainDetected.textContent = status.rain_detected ? 'Yes' : 'No';
            envRainThreshold.textContent = status.rain_threshold;
        }

        async function fetchAllData() {
            loadingOverlay.style.display = 'flex';
            showSection('dataViewerSection');
            try {
                const { data: environmentData, error: environmentError } = await supabase
                    .from('environment')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                if (environmentError) throw environmentError;
                updateEnvironmentTable(environmentData);
                const { data: parkingSlotsData, error: parkingSlotsError } = await supabase
                    .from('parking_slots')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                if (parkingSlotsError) throw parkingSlotsError;
                updateParkingSlotsTable(parkingSlotsData);
                const { data: systemOverviewData, error: systemOverviewError } = await supabase
                    .from('system_overview')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                if (systemOverviewError) throw systemOverviewError;
                updateSystemOverviewTable(systemOverviewData);
                await fetchAccessLogs();
            } catch (error) {
                console.error('Error fetching all data:', error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function updateEnvironmentTable(environmentData) {
            environmentBody.innerHTML = '';
            if (environmentData && environmentData.length > 0) {
                environmentData.forEach(env => {
                    const row = `
                        <tr>
                            <td>${env.id}</td>
                            <td>${env.light_level || '--'}</td>
                            <td>${env.night_mode ? 'Yes' : 'No'}</td>
                            <td>${env.corner_lights || '--'}</td>
                            <td>${env.rain_sensor_value || '--'}</td>
                            <td>${env.rain_detected ? 'Yes' : 'No'}</td>
                            <td>${env.rain_threshold || '--'}</td>
                            <td>${new Date(env.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                    environmentBody.innerHTML += row;
                });
            } else {
                environmentBody.innerHTML = '<tr><td colspan="8">No environment data found.</td></tr>';
            }
        }

        function updateParkingSlotsTable(parkingSlotsData) {
            parkingSlotsBody.innerHTML = '';
            if (parkingSlotsData && parkingSlotsData.length > 0) {
                parkingSlotsData.forEach(slot => {
                    const row = `
                        <tr>
                            <td>${slot.id}</td>
                            <td>${slot.slot_id}</td>
                            <td>${slot.is_occupied ? 'Yes' : 'No'}</td>
                            <td>${slot.sensor_raw || '--'}</td>
                            <td>${slot.sensor_filtered || '--'}</td>
                            <td>${slot.last_changed || '--'}</td>
                            <td>${slot.stable_readings || '--'}</td>
                            <td>${slot.led_status || '--'}</td>
                            <td>${new Date(slot.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                    parkingSlotsBody.innerHTML += row;
                });
            } else {
                parkingSlotsBody.innerHTML = '<tr><td colspan="9">No parking slots data found.</td></tr>';
            }
        }

        function updateSystemOverviewTable(systemOverviewData) {
            systemOverviewBody.innerHTML = '';
            if (systemOverviewData && systemOverviewData.length > 0) {
                systemOverviewData.forEach(sys => {
                    const row = `
                        <tr>
                            <td>${sys.id}</td>
                            <td>${sys.available_slots || '--'}</td>
                            <td>${sys.gate_open ? 'Yes' : 'No'}</td>
                            <td>${sys.ceiling_closed ? 'Yes' : 'No'}</td>
                            <td>${sys.night_mode ? 'Yes' : 'No'}</td>
                            <td>${sys.rain_detected ? 'Yes' : 'No'}</td>
                            <td>${sys.buzzer_active ? 'Yes' : 'No'}</td>
                            <td>${sys.gate_sensor_before ? 'Yes' : 'No'}</td>
                            <td>${sys.gate_sensor_after ? 'Yes' : 'No'}</td>
                            <td>${sys.rain_sensor_value || '--'}</td>
                            <td>${new Date(sys.created_at).toLocaleString()}</td>
                        </tr>
                    `;
                    systemOverviewBody.innerHTML += row;
                });
            } else {
                systemOverviewBody.innerHTML = '<tr><td colspan="11">No system overview data found.</td></tr>';
            }
        }

        function showDataTable(tableId) {
            const tables = ['environmentTable', 'parkingSlotsTable', 'systemOverviewTable', 'accessLogsTable'];
            tables.forEach(id => {
                document.getElementById(id).style.display = id === tableId ? 'block' : 'none';
            });
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('onclick').includes(tableId));
            });
        }

        function setupRealtimeListeners() {
            supabase
                .channel('parking_slots')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'parking_slots' }, payload => {
                    console.log('New parking slot added:', payload.new);
                    fetchDashboardData();
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'parking_slots' }, payload => {
                    console.log('Parking slot updated:', payload.new);
                    fetchDashboardData();
                })
                .subscribe();
            supabase
                .channel('system_overview')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'system_overview' }, payload => {
                    console.log('System overview updated:', payload.new);
                    fetchDashboardData();
                })
                .subscribe();
            supabase
                .channel('environment')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'environment' }, payload => {
                    console.log('Environment data updated:', payload.new);
                    updateSystemStatus(payload.new);
                })
                .subscribe();
            supabase
                .channel('access_logs')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'access_logs' }, payload => {
                    console.log('New access log added:', payload.new);
                    if (document.getElementById('accessLogsTable').style.display === 'block') {
                        fetchAccessLogs();
                    }
                })
                .subscribe();
        }

        async function checkSession() {
            loadingOverlay.style.display = 'flex';
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                authContainer.style.display = 'none';
                mainApp.style.display = 'block';
                const userFullName = session.user.user_metadata?.full_name || session.user.email;
                userName.textContent = userFullName;
                userAvatar.textContent = userFullName.charAt(0).toUpperCase();
                fetchDashboardData();
                setupRealtimeListeners();
                connectMqtt();
            } else {
                authContainer.style.display = 'flex';
                mainApp.style.display = 'none';
            }
            loadingOverlay.style.display = 'none';
        }

        checkSession();
    </script>
</body>
</html>